name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - 'requirements*.txt'
      - '**/*.py'
      - '.github/workflows/ci-sbom-sca.yml'
    branches: [ main, develop ]
  pull_request:
    paths:
      - 'requirements*.txt'
      - '**/*.py'
      - '.github/workflows/ci-sbom-sca.yml'
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: sbom-sca-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom-sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Install Syft
        run: |
          SYFT_VERSION="v1.6.1"
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin ${SYFT_VERSION}
          syft version

      - name: Generate SBOM with Syft
        run: |
          mkdir -p EVIDENCE/P09
          syft dir:. -o cyclonedx-json > EVIDENCE/P09/sbom.json
          ls -lh EVIDENCE/P09/sbom.json
          echo "SBOM file size: $(wc -c < EVIDENCE/P09/sbom.json) bytes"

      - name: Install Grype
        run: |
          GRYPE_VERSION="v0.82.0"
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin ${GRYPE_VERSION}
          grype version

      - name: Run SCA with Grype
        run: |
          grype sbom:EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json || true
          if [ -f "EVIDENCE/P09/sca_report.json" ]; then
            ls -lh EVIDENCE/P09/sca_report.json
            echo "SCA report file size: $(wc -c < EVIDENCE/P09/sca_report.json) bytes"
          else
            echo "Warning: SCA report was not generated"
          fi

      - name: Generate SCA Summary
        run: |
          if [ -f "EVIDENCE/P09/sca_report.json" ]; then
            python3 << 'EOF'
          import json
          import sys
          
          try:
              with open("EVIDENCE/P09/sca_report.json", "r") as f:
                  data = json.load(f)
              
              matches = data.get("matches", [])
              
              severity_counts = {
                  "Critical": 0,
                  "High": 0,
                  "Medium": 0,
                  "Low": 0,
                  "Unknown": 0
              }
              
              for match in matches:
                  vuln = match.get("vulnerability", {})
                  severity = vuln.get("severity", "Unknown")
                  if severity in severity_counts:
                      severity_counts[severity] += 1
              
              summary = f"""# SCA Vulnerability Summary
          
          Generated: {data.get("source", {}).get("timestamp", "N/A")}
          
          ## Severity Distribution
          
          - **Critical**: {severity_counts["Critical"]}
          - **High**: {severity_counts["High"]}
          - **Medium**: {severity_counts["Medium"]}
          - **Low**: {severity_counts["Low"]}
          - **Unknown**: {severity_counts["Unknown"]}
          
          **Total vulnerabilities found**: {len(matches)}
          
          ## Notes
          
          This report is generated automatically by Grype based on the SBOM.
          Review the full report in `sca_report.json` for detailed information.
          
          For vulnerability management policy, see `policy/waivers.yml`.
          """
              
              with open("EVIDENCE/P09/sca_summary.md", "w") as out:
                  out.write(summary)
              
              print("SCA summary generated successfully")
          except Exception as e:
              print(f"Error generating summary: {e}", file=sys.stderr)
              # Create a minimal summary if parsing fails
              with open("EVIDENCE/P09/sca_summary.md", "w") as out:
                  out.write(f"# SCA Vulnerability Summary\n\nError generating summary: {e}\n")
              sys.exit(1)
          EOF
          else
              echo "# SCA Vulnerability Summary" > EVIDENCE/P09/sca_summary.md
              echo "" >> EVIDENCE/P09/sca_summary.md
              echo "No SCA report generated." >> EVIDENCE/P09/sca_summary.md
          fi

      - name: Upload SBOM & SCA artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-sca-evidence
          path: |
            EVIDENCE/P09/sbom.json
            EVIDENCE/P09/sca_report.json
            EVIDENCE/P09/sca_summary.md
          retention-days: 30
