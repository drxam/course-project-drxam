name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - '**/*.py'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.toml'
      - '**/*.json'
      - '.github/workflows/ci-sast-secrets.yml'
      - 'security/**'
    branches: [ main, develop ]
  pull_request:
    paths:
      - '**/*.py'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.toml'
      - '**/*.json'
      - '.github/workflows/ci-sast-secrets.yml'
      - 'security/**'
    branches: [ main ]

permissions:
  contents: read
  security-events: write

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep SAST
        run: |
          mkdir -p EVIDENCE/P10
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            -w /src \
            returntocorp/semgrep:latest \
            semgrep ci \
              --config p/ci \
              --config /src/security/semgrep/rules.yml \
              --sarif \
              --output /src/EVIDENCE/P10/semgrep.sarif \
              --metrics=off \
              --disable-nosem || true
          if [ -f "EVIDENCE/P10/semgrep.sarif" ]; then
            echo "Semgrep SARIF file generated successfully"
            ls -lh EVIDENCE/P10/semgrep.sarif
          else
            echo "Warning: Semgrep SARIF file was not generated, creating empty file"
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[]}' > EVIDENCE/P10/semgrep.sarif
          fi

      - name: Run Gitleaks secrets scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            -w /repo \
            zricethezav/gitleaks:latest \
            detect \
              --no-banner \
              --config=/repo/security/.gitleaks.toml \
              --source=/repo \
              --report-format=json \
              --report-path=/repo/EVIDENCE/P10/gitleaks.json \
              --verbose || true
          if [ -f "EVIDENCE/P10/gitleaks.json" ]; then
            echo "Gitleaks report generated successfully"
            ls -lh EVIDENCE/P10/gitleaks.json
          else
            echo "Warning: Gitleaks report was not generated, creating empty file"
            echo '[]' > EVIDENCE/P10/gitleaks.json
          fi

      - name: Generate SAST Summary
        run: |
          if [ -f "EVIDENCE/P10/semgrep.sarif" ]; then
            python3 << 'EOF'
          import json
          import sys
          from datetime import datetime
          
          try:
              with open("EVIDENCE/P10/semgrep.sarif", "r") as f:
                  data = json.load(f)
              
              runs = data.get("runs", [])
              total_findings = 0
              severity_counts = {
                  "error": 0,
                  "warning": 0,
                  "note": 0,
                  "none": 0
              }
              
              findings_by_rule = {}
              
              for run in runs:
                  results = run.get("results", [])
                  for result in results:
                      total_findings += 1
                      level = result.get("level", "none")
                      if level in severity_counts:
                          severity_counts[level] += 1
                      
                      rule_id = result.get("ruleId", "unknown")
                      if rule_id not in findings_by_rule:
                          findings_by_rule[rule_id] = 0
                      findings_by_rule[rule_id] += 1
              
              summary = f"""# SAST & Secrets Scan Summary
          
          Generated: {datetime.now().isoformat()}
          Workflow: Security - SAST & Secrets
          Commit: {sys.argv[1] if len(sys.argv) > 1 else "N/A"}
          
          ## Semgrep SAST Results
          
          **Total findings**: {total_findings}
          
          ### Severity Distribution
          
          - **Error**: {severity_counts["error"]}
          - **Warning**: {severity_counts["warning"]}
          - **Note**: {severity_counts["note"]}
          - **None**: {severity_counts["none"]}
          
          ### Top Rules Triggered
          
          """
              
              # Sort rules by count
              sorted_rules = sorted(findings_by_rule.items(), key=lambda x: x[1], reverse=True)[:10]
              for rule_id, count in sorted_rules:
                  summary += f"- `{rule_id}`: {count} finding(s)\n"
              
              summary += f"""
          
          ## Gitleaks Secrets Scan
          
          See `gitleaks.json` for detailed results.
          
          ## Notes
          
          - Semgrep uses profile `p/ci` plus custom rules from `security/semgrep/rules.yml`
          - Gitleaks uses configuration from `security/.gitleaks.toml`
          - All findings should be reviewed and triaged
          - False positives should be added to allowlists with justification
          
          ## Next Steps
          
          1. Review Semgrep findings in `semgrep.sarif`
          2. Review Gitleaks findings in `gitleaks.json`
          3. Fix critical issues or add to backlog with Issue tracking
          4. Update allowlists for false positives with clear justification
          """
              
              with open("EVIDENCE/P10/sast_summary.md", "w") as out:
                  out.write(summary)
              
              print(f"SAST summary generated: {total_findings} findings")
          except Exception as e:
              print(f"Error generating summary: {e}", file=sys.stderr)
              with open("EVIDENCE/P10/sast_summary.md", "w") as out:
                  out.write(f"# SAST & Secrets Scan Summary\n\nError generating summary: {e}\n")
              sys.exit(1)
          EOF
          ${{ github.sha }}
          else
              echo "# SAST & Secrets Scan Summary" > EVIDENCE/P10/sast_summary.md
              echo "" >> EVIDENCE/P10/sast_summary.md
              echo "No Semgrep report generated." >> EVIDENCE/P10/sast_summary.md
          fi

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('EVIDENCE/P10/semgrep.sarif') != ''
        with:
          sarif_file: EVIDENCE/P10/semgrep.sarif
          wait-for-processing: false

      - name: Upload SAST & Secrets artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-secrets-evidence
          path: |
            EVIDENCE/P10/semgrep.sarif
            EVIDENCE/P10/gitleaks.json
            EVIDENCE/P10/sast_summary.md
          retention-days: 30

