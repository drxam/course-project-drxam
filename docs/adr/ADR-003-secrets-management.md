# ADR-003: Управление секретами и безопасное логирование

## Status
Принято

## Context
В приложении могут использоваться секретные данные (API ключи, токены, пароли), которые не должны попадать в:
1. Код приложения (hardcoded secrets)
2. Логи приложения
3. Git репозиторий
4. Ответы API

**Текущая ситуация:**
- Нет явного механизма управления секретами
- Нет валидации того, что секреты не логируются
- Потенциальная утечка через логи (F11: Log Validation Errors)

**Связь с угрозами:**
- F11: Log Validation Errors — Information Disclosure (утечка через логи)
- NFR-007: 100% security events logged (без утечки чувствительных данных)

## Decision
Реализовать стратегию управления секретами и безопасного логирования:

### 1. Источник секретов
- **Переменные окружения** — основной источник для секретов
- Использование `.env` файла для локальной разработки (не коммитится)
- В production: секреты из переменных окружения контейнера/K8s secrets

### 2. Валидация секретов при запуске
- Проверка наличия обязательных секретов при старте приложения
- Fail-fast при отсутствии критичных секретов

### 3. Маскирование в логах
- Автоматическое маскирование известных паттернов секретов
- Замена на `***MASKED***` в логах
- Паттерны для маскирования:
  - `password=...`
  - `token=...`
  - `api_key=...`
  - `secret=...`
  - `authorization: Bearer ...`

### 4. Запрет hardcoded секретов
- Использование SAST инструментов (Semgrep/Bandit) для поиска
- Code review проверка
- Pre-commit hook для поиска паттернов

### 5. Ротация секретов (будущее)
- Планируется поддержка ротации через переменные окружения
- Graceful перезагрузка секретов без перезапуска (v1.1+)

## Alternatives

### Альтернатива 1: Hardcoded секреты в коде
**Плюсы:**
- Простота использования

**Минусы:**
- Критическая уязвимость безопасности
- Утечка через Git
- Невозможность ротации без передеплоя
- Нарушение best practices

### Альтернатива 2: Конфигурационные файлы в репозитории
**Плюсы:**
- Удобство для разработки

**Минусы:**
- Риск коммита секретов
- Нужна дополнительная защита файлов
- Сложная ротация

### Альтернатива 3: Переменные окружения + маскирование (выбрано)
**Плюсы:**
- Стандартная практика
- Секреты не попадают в код/репозиторий
- Простая ротация
- Автоматическое маскирование в логах
- Соответствие 12-factor app

**Минусы:**
- Требует настройки окружения
- Нужна дисциплина у разработчиков

### Альтернатива 4: Использование Vault/AWS Secrets Manager
**Плюсы:**
- Профессиональное решение
- Автоматическая ротация
- Централизованное управление

**Минусы:**
- Избыточно для учебного проекта
- Дополнительная инфраструктура
- Усложнение развёртывания

## Consequences

### Положительные:
- Улучшенная безопасность секретов
- Предотвращение утечек через логи
- Соответствие best practices
- Простая ротация через переменные окружения
- Fail-fast при отсутствии секретов

### Отрицательные:
- Требует настройки окружения
- Нужна дисциплина у разработчиков (не коммитить .env)
- Небольшое увеличение сложности настройки

### Security Impact:
- ✅ Снижение риска Information Disclosure (F11): секреты не попадают в логи
- ✅ Соответствие NFR-007: логирование без утечки чувствительных данных
- ✅ Защита от утечки через Git (через .gitignore)
- ✅ Предотвращение hardcoded secrets (CWE-798)
- ✅ Улучшенная аудируемость: логи содержат события, но не секреты

## Rollout Plan

### Definition of Done (DoD):
1. Создан модуль `app/security/secrets.py` для работы с секретами
2. Реализована функция маскирования секретов в логах
3. Добавлена валидация обязательных секретов при старте
4. Обновлён `.gitignore` для исключения `.env`
5. Создан `.env.example` с шаблоном переменных (без реальных значений)
6. Добавлены тесты для маскирования
7. Настроен pre-commit hook для поиска hardcoded секретов

### План внедрения:
1. **Шаг 1:** Создать `app/security/secrets.py` с функциями:
   - `get_secret(key: str) -> str | None`
   - `require_secret(key: str) -> str`
   - `mask_secrets_in_string(text: str) -> str`
2. **Шаг 2:** Добавить валидацию секретов в `app/main.py` startup
3. **Шаг 3:** Интегрировать маскирование в логирование
4. **Шаг 4:** Создать `.env.example`
5. **Шаг 5:** Обновить `.gitignore`
6. **Шаг 6:** Добавить тесты
7. **Шаг 7:** Настроить pre-commit hook (опционально, для ★★)

### Критерии проверки:
- ✅ Тест: проверка маскирования `password=secret123` → `password=***MASKED***`
- ✅ Тест: проверка маскирования `token=abc123` → `token=***MASKED***`
- ✅ Тест: приложение не запускается без обязательных секретов
- ✅ `.env` в `.gitignore`
- ✅ `.env.example` существует без реальных секретов

## Links
- NFR-007: 100% security events logged (из P03)
- F11: Log Validation Errors — Information Disclosure (из P04 STRIDE.md)
- CWE-798: Use of Hard-coded Credentials
- 12-Factor App: https://12factor.net/config
- Тест: `tests/test_secrets.py`
