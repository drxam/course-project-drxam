# ADR-001: RFC 7807 формат для обработки ошибок

## Status
Принято

## Context
В текущей реализации приложения (FastAPI) ошибки возвращаются в произвольном JSON-формате:
```json
{
  "error": {"code": "not_found", "message": "item not found"}
}
```

Это создаёт проблемы:
1. Клиенты не могут стандартизированно обрабатывать ошибки
2. Нет механизма для correlation_id (связь логов и запросов)
3. Недостаточная детализация для отладки без утечки информации
4. Несоответствие с требованиями NFR-003 (Minimal data exposure) и F11 (Log Validation Errors)

**Связь с угрозами:**
- F11: Log Validation Errors — Information Disclosure (утечка через логи)
- NFR-003: Minimal data exposure в сообщениях об ошибках

## Decision
Принять RFC 7807 (Problem Details for HTTP APIs) как стандарт для всех ошибок API.

### Реализация:
1. Все ошибки возвращаются с заголовком `Content-Type: application/problem+json`
2. Структура ответа:
   - `type` — URI идентификатор типа ошибки
   - `title` — краткое описание
   - `status` — HTTP статус код
   - `detail` — детальное сообщение (маскированное в production)
   - `instance` — URI конкретного запроса
   - `correlation_id` — уникальный ID для связи с логами (расширение)
   - `errors` (опционально) — массив ошибок валидации

3. В production `detail` содержит обобщённые сообщения
4. В development `detail` может содержать больше информации
5. Все ошибки логируются с `correlation_id`

## Alternatives

### Альтернатива 1: Текущий формат (as-is)
**Плюсы:**
- Уже реализовано
- Простой формат

**Минусы:**
- Нестандартный формат
- Нет correlation_id
- Сложно отслеживать ошибки
- Не соответствует best practices

### Альтернатива 2: GraphQL-стиль ошибок
**Плюсы:**
- Структурированные ошибки валидации
- Расширяемый формат

**Минусы:**
- Не подходит для REST API
- Дополнительная зависимость
- Избыточно для текущего проекта

### Альтернатива 3: RFC 7807 (выбрано)
**Плюсы:**
- Стандартизированный формат (RFC)
- Широкая поддержка в инструментах
- Поддержка correlation_id через extensions
- Соответствует best practices
- Простая реализация на FastAPI

**Минусы:**
- Требует миграции существующих клиентов (минимальная)
- Небольшое увеличение размера ответа

## Consequences

### Положительные:
- Стандартизация обработки ошибок
- Улучшенная трассируемость через correlation_id
- Соответствие industry standards
- Упрощённая отладка в development
- Безопасное маскирование деталей в production

### Отрицательные:
- Требуется обновление существующих клиентов
- Небольшое увеличение размера ответов

### Security Impact:
- ✅ Снижение риска Information Disclosure (F11): маскирование деталей в production
- ✅ Улучшение auditability: correlation_id связывает запросы и логи
- ✅ Соответствие NFR-003: минимальная экспозиция данных в ошибках
- ⚠️ Риск: correlation_id может использоваться для атак (enumeration) — смягчено использованием UUID

## Rollout Plan

### Definition of Done (DoD):
1. Все существующие обработчики ошибок используют RFC 7807
2. Добавлен correlation_id в каждый ответ с ошибкой
3. Реализовано маскирование деталей для production
4. Добавлены тесты для проверки формата
5. Обновлена документация API

### План внедрения:
1. **Шаг 1:** Создать middleware для генерации correlation_id
2. **Шаг 2:** Реализовать ProblemDetail модель (Pydantic)
3. **Шаг 3:** Обновить exception handlers
4. **Шаг 4:** Добавить тесты (позитивные и негативные)
5. **Шаг 5:** Обновить README с примерами ошибок

### Критерии проверки:
- ✅ Все ошибки возвращают `Content-Type: application/problem+json`
- ✅ Все ответы содержат `correlation_id`
- ✅ Тесты проверяют структуру RFC 7807
- ✅ Тест проверяет маскирование деталей в production режиме

## Links
- NFR-003: Minimal data exposure (из P03)
- F11: Log Validation Errors (из P04 STRIDE.md)
- RFC 7807: https://tools.ietf.org/html/rfc7807
- Тест: `tests/test_rfc7807.py::test_error_format`
