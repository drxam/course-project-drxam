# ADR-002: Валидация файлов и защита от path traversal

## Status
Принято

## Context
В текущей версии приложения нет функционала загрузки файлов. При добавлении этой возможности необходимо защититься от следующих угроз:
1. **Path Traversal** — загрузка файлов вне разрешённой директории (`../../etc/passwd`)
2. **Неверный MIME-тип** — подмена типа файла (загрузка `.exe` как `.jpg`)
3. **Magic bytes обход** — файл с расширением `.jpg`, но реальное содержимое — executable
4. **DoS через большой файл** — загрузка огромных файлов для исчерпания ресурсов
5. **Symlink атаки** — создание симлинков на чувствительные файлы

**Связь с угрозами:**
- F1: POST /items — Injection атака (расширение на файлы)
- F4: Input Validator — Tampering (обход валидации)
- NFR-004: 100% validation всех входных данных

## Decision
Реализовать многоуровневую защиту загрузки файлов:

### 1. Валидация размера файла
- Максимальный размер: 10 MB
- Проверка до начала обработки

### 2. Проверка Magic Bytes
- Проверка первых байтов файла для определения реального типа
- Поддержка: JPEG, PNG, PDF, TXT
- Отклонение файлов с несовпадением расширения и содержимого

### 3. Канонизация путей
- Использование `os.path.normpath()` для нормализации
- Проверка, что итоговый путь находится внутри разрешённой директории

### 4. Запрет симлинков
- Проверка `os.path.islink()` перед сохранением
- Отклонение любых симлинков

### 5. UUID имена файлов
- Генерация UUID для имени сохраняемого файла
- Оригинальное имя сохраняется в метаданных (опционально)
- Предотвращает перезапись и enumeration атаки

### 6. Валидация MIME типа
- Проверка Content-Type из заголовка
- Сопоставление с magic bytes

## Alternatives

### Альтернатива 1: Только проверка расширения
**Плюсы:**
- Простая реализация
- Быстрая проверка

**Минусы:**
- Легко обойти (переименование файла)
- Не защищает от маскировки типа
- Уязвим к path traversal

### Альтернатива 2: Проверка расширения + размер
**Плюсы:**
- Базовая защита
- Защита от DoS

**Минусы:**
- Не защищает от подмены содержимого
- Уязвим к path traversal
- Не проверяет реальный тип файла

### Альтернатива 3: Полная валидация (выбрано)
**Плюсы:**
- Многоуровневая защита
- Проверка magic bytes предотвращает маскировку
- UUID имена предотвращают перезапись
- Канонизация путей защищает от traversal
- Запрет симлинков защищает от symlink атак

**Минусы:**
- Более сложная реализация
- Небольшая задержка на проверку magic bytes
- Требует библиотеку для magic bytes (python-magic или filetype)

## Consequences

### Положительные:
- Сильная защита от file upload атак
- Соответствие NFR-004 (100% validation)
- Предотвращение path traversal
- Защита от DoS через большие файлы
- Улучшенная безопасность хранилища

### Отрицательные:
- Увеличение сложности кода
- Дополнительная зависимость (python-magic или filetype)
- Небольшое увеличение времени обработки

### Security Impact:
- ✅ Снижение риска Tampering (F4): обход валидации через файлы
- ✅ Снижение риска Injection (F1): загрузка вредоносных файлов
- ✅ Соответствие NFR-004: полная валидация всех входных данных (включая файлы)
- ✅ Защита от Path Traversal (CWE-22)
- ✅ Защита от Symlink атак (CWE-61)
- ✅ Защита от DoS через большие файлы

## Rollout Plan

### Definition of Done (DoD):
1. Реализован эндпойнт `POST /upload` с валидацией
2. Проверка magic bytes для поддерживаемых типов
3. Канонизация путей и проверка на traversal
4. Генерация UUID имён для сохранённых файлов
5. Отклонение симлинков
6. Добавлены тесты (позитивные и негативные):
   - Большой файл (>10MB)
   - Неверная сигнатура (magic bytes)
   - Path traversal попытка
   - Неверный MIME тип
   - Симлинк

### План внедрения:
1. **Шаг 1:** Добавить зависимость `python-magic-bin` или `filetype`
2. **Шаг 2:** Создать модуль `app/security/file_validation.py`
3. **Шаг 3:** Реализовать функции валидации
4. **Шаг 4:** Добавить эндпойнт `/upload` в `app/main.py`
5. **Шаг 5:** Добавить тесты в `tests/test_file_upload.py`
6. **Шаг 6:** Создать директорию `uploads/` с правильными правами

### Критерии проверки:
- ✅ Тест: отклонение файла >10MB
- ✅ Тест: отклонение файла с неверными magic bytes
- ✅ Тест: отклонение path traversal (`../../../etc/passwd`)
- ✅ Тест: отклонение неверного MIME типа
- ✅ Тест: успешная загрузка валидного файла

## Links
- NFR-004: 100% validation (из P03)
- F1: POST /items — Injection атака (из P04 STRIDE.md)
- F4: Input Validator — Tampering (из P04 STRIDE.md)
- CWE-22: Improper Limitation of a Pathname to a Restricted Directory
- CWE-61: UNIX Symbolic Link (Symlink) Following
- Тест: `tests/test_file_upload.py`
